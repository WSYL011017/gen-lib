# 通用依赖库框架设计文档

## 1. 总体架构设计

### 1.1 架构原则
- **分层解耦**: 严格按照功能职责分层，降低模块间耦合
- **零侵入**: 采用组合优于继承的设计理念
- **可扩展**: 基于SPI和策略模式实现可插拔架构
- **标准化**: 遵循Spring Boot Starter标准和Java规范

### 1.2 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    gen-lib (Parent POM)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ gen-lib-bom │  │gen-lib-build│  │gen-lib-deps │         │
│  │   (依赖管理)  │  │  (构建插件)  │  │  (第三方依赖) │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                        核心层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │gen-lib-core │  │gen-lib-utils│  │gen-lib-config│        │
│  │  (核心抽象)  │  │  (工具类库)  │  │  (配置管理)  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                      功能扩展层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │gen-lib-cache│  │gen-lib-data │  │gen-lib-web  │         │
│  │  (缓存抽象)  │  │  (数据访问)  │  │  (Web增强)  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                      业务增强层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │gen-lib-     │  │gen-lib-     │  │gen-lib-     │         │
│  │business     │  │security     │  │monitor      │         │
│  │ (业务基础)   │  │ (安全增强)   │  │ (监控增强)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                      集成适配层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │gen-lib-     │  │gen-lib-     │  │gen-lib-     │         │
│  │spring-boot- │  │cloud-       │  │samples      │         │
│  │starter      │  │starter      │  │ (示例项目)   │         │
│  │(SpringBoot) │  │(SpringCloud)│  │             │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 2. 模块详细设计

### 2.1 gen-lib-core (核心抽象模块)

#### 2.1.1 包结构设计
```
com.genlib.core
├── constants/              # 常量定义
│   ├── CommonConstants     # 通用常量
│   ├── HttpConstants       # HTTP相关常量
│   └── DateConstants       # 日期格式常量
├── enums/                  # 枚举定义
│   ├── ResultCodeEnum      # 响应码枚举
│   ├── StatusEnum          # 状态枚举
│   └── BusinessTypeEnum    # 业务类型枚举
├── exception/              # 异常体系
│   ├── BaseException       # 基础异常类
│   ├── BusinessException   # 业务异常
│   ├── SystemException     # 系统异常
│   └── ParamException      # 参数异常
├── model/                  # 通用模型
│   ├── Result<T>           # 统一响应结果
│   ├── PageResult<T>       # 分页响应结果
│   ├── BaseEntity          # 基础实体类
│   └── AuditEntity         # 审计实体类
├── annotation/             # 注解定义
│   ├── ApiVersion          # API版本注解
│   ├── TraceLog            # 链路追踪注解
│   └── BusinessLog         # 业务日志注解
└── spi/                    # SPI接口定义
    ├── ExtensionPoint      # 扩展点接口
    ├── PluginManager       # 插件管理器
    └── ConfigProvider      # 配置提供者
```

#### 2.1.2 核心类设计

**统一响应结果 Result<T>**
```java
public class Result<T> implements Serializable {
    private String code;        // 响应码
    private String message;     // 响应消息
    private T data;            // 响应数据
    private Long timestamp;    // 时间戳
    private String traceId;    // 链路追踪ID
    
    // 静态构造方法
    public static <T> Result<T> success(T data);
    public static <T> Result<T> error(String code, String message);
    public static <T> Result<T> error(ResultCodeEnum resultCode);
}
```

**基础实体类 BaseEntity**
```java
public abstract class BaseEntity implements Serializable {
    protected Long id;              // 主键ID
    protected LocalDateTime createTime;  // 创建时间
    protected LocalDateTime updateTime;  // 更新时间
    protected Integer version;      // 乐观锁版本号
    protected Boolean deleted;      // 逻辑删除标记
}
```

### 2.2 gen-lib-utils (工具类模块)

#### 2.2.1 包结构设计
```
com.genlib.utils
├── text/                   # 文本处理
│   ├── StringUtils         # 字符串工具
│   ├── RegexUtils          # 正则表达式工具
│   └── TemplateUtils       # 模板处理工具
├── time/                   # 时间处理
│   ├── DateUtils           # 日期工具
│   ├── TimeUtils           # 时间工具
│   └── CronUtils           # Cron表达式工具
├── collection/             # 集合处理
│   ├── CollectionUtils     # 集合工具
│   ├── StreamUtils         # Stream流工具
│   └── TreeUtils           # 树结构工具
├── crypto/                 # 加密解密
│   ├── AESUtils            # AES加密
│   ├── RSAUtils            # RSA加密
│   ├── MD5Utils            # MD5摘要
│   └── JWTUtils            # JWT工具
├── http/                   # HTTP工具
│   ├── HttpUtils           # HTTP客户端
│   ├── URLUtils            # URL处理
│   └── IPUtils             # IP地址工具
├── json/                   # JSON处理
│   ├── JsonUtils           # JSON工具
│   ├── JsonPath            # JsonPath查询
│   └── XmlUtils            # XML处理
├── io/                     # IO操作
│   ├── FileUtils           # 文件操作
│   ├── IOUtils             # IO流操作
│   └── ZipUtils            # 压缩解压
└── validation/             # 数据验证
    ├── ValidatorUtils      # 数据验证
    ├── IdCardUtils         # 身份证验证
    └── BankCardUtils       # 银行卡验证
```

#### 2.2.2 工具类设计特点
- **线程安全**: 所有工具类方法都是线程安全的
- **空值处理**: 优雅处理null值，避免NPE
- **性能优化**: 使用缓存、池化等技术提升性能
- **异常处理**: 统一的异常处理和日志记录

### 2.3 gen-lib-config (配置管理模块)

#### 2.3.1 配置抽象层设计
```java
// 配置提供者接口
public interface ConfigProvider {
    String getString(String key);
    <T> T getObject(String key, Class<T> clazz);
    void refresh();
    boolean exists(String key);
}

// 配置监听器
public interface ConfigListener {
    void onConfigChange(String key, Object oldValue, Object newValue);
}

// 配置管理器
public interface ConfigManager {
    void registerProvider(ConfigProvider provider);
    void addListener(String key, ConfigListener listener);
    <T> T getConfig(String key, Class<T> clazz, T defaultValue);
}
```

#### 2.3.2 多配置源支持
- **Properties配置**: 支持.properties文件
- **YAML配置**: 支持.yml/.yaml文件
- **环境变量**: 支持系统环境变量
- **Nacos配置**: 支持Nacos配置中心
- **Consul配置**: 支持Consul配置中心

### 2.4 gen-lib-cache (缓存抽象模块)

#### 2.4.1 缓存抽象接口
```java
// 统一缓存接口
public interface Cache<K, V> {
    void put(K key, V value);
    void put(K key, V value, Duration expiration);
    Optional<V> get(K key);
    void evict(K key);
    void clear();
    boolean exists(K key);
    Set<K> keys();
}

// 缓存管理器
public interface CacheManager {
    <K, V> Cache<K, V> getCache(String name);
    <K, V> Cache<K, V> getCache(String name, Class<K> keyType, Class<V> valueType);
    Collection<String> getCacheNames();
}
```

#### 2.4.2 缓存实现策略
- **Redis缓存**: 分布式缓存实现
- **Caffeine缓存**: 高性能本地缓存
- **EhCache缓存**: 传统本地缓存
- **复合缓存**: 多级缓存组合

### 2.5 gen-lib-data (数据访问模块)

#### 2.5.1 ORM适配器设计
```java
// 通用数据访问接口
public interface BaseRepository<T, ID> {
    T save(T entity);
    void delete(ID id);
    Optional<T> findById(ID id);
    List<T> findAll();
    Page<T> findAll(Pageable pageable);
}

// 查询构建器
public interface QueryBuilder<T> {
    QueryBuilder<T> eq(String field, Object value);
    QueryBuilder<T> like(String field, String value);
    QueryBuilder<T> in(String field, Collection<?> values);
    QueryBuilder<T> orderBy(String field, Order order);
    List<T> list();
    Page<T> page(Pageable pageable);
}
```

#### 2.5.2 多数据源支持
```java
// 数据源切换注解
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface DataSource {
    String value() default "master";
}

// 动态数据源配置
@ConfigurationProperties(prefix = "genlib.datasource")
public class DataSourceProperties {
    private Map<String, DataSourceConfig> sources;
    private String primary = "master";
}
```

### 2.6 gen-lib-business (业务基础模块)

#### 2.6.1 基础业务组件
```java
// 分页参数
public class PageRequest {
    private int pageNum = 1;      // 页码
    private int pageSize = 10;    // 页大小
    private String orderBy;       // 排序字段
    private String order;         // 排序方向
}

// 查询条件构建器
public class QueryWrapper<T> {
    public QueryWrapper<T> eq(String column, Object val);
    public QueryWrapper<T> like(String column, Object val);
    public QueryWrapper<T> between(String column, Object val1, Object val2);
    public QueryWrapper<T> orderByAsc(String column);
    public QueryWrapper<T> orderByDesc(String column);
}
```

### 2.7 gen-lib-spring-boot-starter (Spring Boot集成)

#### 2.7.1 自动配置类设计
```java
@Configuration
@EnableConfigurationProperties(GenLibProperties.class)
public class GenLibAutoConfiguration {
    
    @Bean
    @ConditionalOnMissingBean
    public ConfigManager configManager() {
        return new DefaultConfigManager();
    }
    
    @Bean
    @ConditionalOnProperty(prefix = "genlib.cache", name = "enabled", havingValue = "true")
    public CacheManager cacheManager() {
        return new DefaultCacheManager();
    }
}
```

#### 2.7.2 配置属性类
```java
@ConfigurationProperties(prefix = "genlib")
public class GenLibProperties {
    private CacheProperties cache = new CacheProperties();
    private DataProperties data = new DataProperties();
    private SecurityProperties security = new SecurityProperties();
    
    public static class CacheProperties {
        private boolean enabled = true;
        private String type = "redis";
        private Duration defaultExpiration = Duration.ofHours(1);
    }
}
```

## 3. 扩展机制设计

### 3.1 SPI扩展点
```java
// 扩展点接口
public interface ExtensionPoint {
    String getName();
    int getOrder();
    boolean isEnabled();
}

// 缓存扩展点
public interface CacheExtension extends ExtensionPoint {
    Cache<Object, Object> createCache(String name, CacheConfig config);
}

// 数据源扩展点
public interface DataSourceExtension extends ExtensionPoint {
    DataSource createDataSource(DataSourceConfig config);
}
```

### 3.2 插件化架构
```java
// 插件接口
public interface Plugin {
    void init(PluginContext context);
    void start();
    void stop();
    void destroy();
}

// 插件管理器
public interface PluginManager {
    void loadPlugin(String pluginPath);
    void enablePlugin(String pluginId);
    void disablePlugin(String pluginId);
    List<Plugin> getPlugins();
}
```

## 4. 设计模式应用

### 4.1 策略模式
- **缓存策略**: 不同缓存实现的策略选择
- **序列化策略**: JSON、XML、Protobuf等序列化方式
- **数据源策略**: 主从、读写分离等数据源选择

### 4.2 工厂模式
- **组件工厂**: 各种组件的创建工厂
- **配置工厂**: 不同配置源的工厂
- **缓存工厂**: 不同缓存类型的工厂

### 4.3 模板方法模式
- **数据访问模板**: 统一的数据访问模板
- **HTTP调用模板**: 统一的HTTP调用模板
- **缓存操作模板**: 统一的缓存操作模板

### 4.4 装饰器模式
- **缓存装饰器**: 为缓存添加监控、统计功能
- **数据源装饰器**: 为数据源添加连接池、监控功能

## 5. 性能优化设计

### 5.1 缓存优化
- **多级缓存**: L1本地缓存 + L2分布式缓存
- **缓存预热**: 系统启动时预加载热点数据
- **缓存更新**: 异步更新、失效通知机制

### 5.2 连接池优化
- **数据库连接池**: HikariCP优化配置
- **HTTP连接池**: OkHttp连接池优化
- **线程池**: 异步处理线程池优化

### 5.3 序列化优化
- **Fast JSON**: 高性能JSON序列化
- **Kryo**: 高效对象序列化
- **Protobuf**: 跨语言序列化协议

## 6. 安全设计

### 6.1 数据安全
- **敏感数据加密**: 配置文件敏感信息加密
- **传输加密**: HTTPS、SSL/TLS支持
- **存储加密**: 数据库字段级加密

### 6.2 访问控制
- **权限验证**: 基于角色的访问控制
- **API安全**: 接口认证和授权
- **SQL注入防护**: 参数化查询、输入验证

## 7. 监控和诊断

### 7.1 性能监控
- **方法耗时**: AOP方法执行时间监控
- **资源使用**: CPU、内存、IO监控
- **业务指标**: 自定义业务指标监控

### 7.2 日志体系
- **结构化日志**: JSON格式日志输出
- **链路追踪**: 分布式链路追踪支持
- **异常日志**: 统一异常日志处理

### 7.3 健康检查
- **组件健康**: 各组件健康状态检查
- **依赖检查**: 外部依赖健康检查
- **自动恢复**: 故障自动恢复机制

这个框架设计确保了通用依赖库的**高内聚、低耦合、易扩展、零侵入**的特性，为企业级Java应用提供了强大的基础支撑。